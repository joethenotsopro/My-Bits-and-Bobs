**********Tested (and working) on Debian Stable/LMDE 3 Cindy***********
**********YMMV on other distributions although I daresay it ***********
**********  should work on all Debian based distributions   ***********




This guide assumes you have the NVidia/Bumblebee drivers installed and working, all the libraries in the correct
places and both Optirun and Primusrun behave without any complaining. You may even have VirtualGL installed too! 




Do these tests to check you're all up and running:

optirun glxgears
optirun -b primus glxgears
primusrun glxgears

Also head to /etc/bumblebee/bumblebee.conf and swap between the rendering bridges too. Do all this BEFORE you 
start the rest of this guide... it will help sort out any driver and library issues before you start.

# Acceleration/ rendering bridge, possible values are auto, virtualgl and
# primus.
Bridge=virtualgl




Do not ask for any help with driver or library issues - NVidia already owe me a trip to a PTSD clinic.
This guide is 100% by own blood sweat and tears and there was plenty.





Before you go any further install nvidia-persistenced...

sudo apt-get install nvidia-persistenced

nvidia-persistenced was a real big pain in the [ForrestGump]butt-ocks[/ForrestGump] to getting running - it
turns out it needs access to directories that aren't created on it's installation AND the directories I eventually
figured out were needed are also then removed on reboot! Yay NVidia!




Any tinfoil hat wearing Linux users can stop reading now lest they break their jaws on the floor when they read 
the rest of the guide. Though I do apply a small "hack" to help out with that...




First off edit $HOME/.xsessionrc in your favorite editor and add the following. Save and reboot.

printf 'YOURPASSWORD\n' | sudo -S mkdir /var/run/nvidia-persistenced
printf 'YOURPASSWORD\n' | sudo -S chgrp users /var/run/nvidia-persistenced
printf 'YOURPASSWORD\n' | chmod g+rw /var/run/nvidia-persistenced
printf 'YOURPASSWORD\n' | sudo -S optirun -c :8 nvidia-persistenced --no-persistence-mode
shred -u -z .bash_history

It's also good practice to set permissions for others even on single user systems.

chmod go-rwx $HOME/.xsessionrc (do this for your launch scripts too)




Here are a few example scripts I use to launch games, the first is for launching the Demul Dreamcast emulator
with Wine, it's not exactly security friendly (as with .xsessionrc) but with the correct permissions set on 
the scripts I don't see much of a problem - even less so on single user systems but as I said above, set the
permissions!.

The GPUGraphicsClockOffset and GPUMemoryTransferRateOffset settings below are for underclocking my NVidia
card so it runs 24/7 without issues. It wasn't stable in Windows either.... 

#!/bin/bash
export WINEPREFIX=/home/joethenotsopro/wine-bottles/demul
cd '/home/joethenotsopro/wine-bottles/demul/drive_c/demul'
printf 'YOURPASSWORD\n' | sudo -S optirun -c :8 nvidia-smi -pm 1
optirun nvidia-settings -c :8 -a [gpu:0]/GPUPowerMizerMode=1
optirun nvidia-settings -c :8 -a [gpu:0]/GPUGraphicsClockOffset[2]=-171
optirun nvidia-settings -c :8 -a [gpu:0]/GPUMemoryTransferRateOffset[2]=-600
vblank_mode=0 primusrun wine "c:\demul\demul.exe"
printf 'YOURPASSWORD\n' | sudo -S optirun -c :8 nvidia-smi -pm 0

Save it as $HOME/bin/yourscript.sh and then:

chmod u+x,go-rwx $HOME/bin/yourscript.sh

The script above can be tailored to use for any Wine program, including Steam. Unfortunately the Linux version
of Steam does not like my launch scripts and defies my hacking around it's innards so you have to either try and
run the Linux games from outside Steam (War Thunder works for instance - see below) or try and hack something in
Steams game launch options... I have tried but the Optimus card needs Persistence mode to run games with the
dedicated card in Linux and Steams launch options are not script friendly.

Here's my War Thunder launch script, it does work with a small complaint at the beginning of the script. As you 
can see I'm running the game directly by avoiding War Thunders own game launcher. If your game has a launcher
then that games launcher will detach the scripts persistence process, so do launch the game directly otherwise
you will be running it with the Intel card without knowing unless you check the LED indicator on the laptop!

#!/bin/bash
printf 'YOURPASSWORD\n' | sudo -S optirun -c :8 nvidia-smi -pm 1
optirun nvidia-settings -c :8 -a [gpu:0]/GPUPowerMizerMode=1
optirun nvidia-settings -c :8 -a [gpu:0]/GPUGraphicsClockOffset[2]=-171
optirun nvidia-settings -c :8 -a [gpu:0]/GPUMemoryTransferRateOffset[2]=-600
vblank_mode=0 primusrun '/home/joenotsopro/.steam/steam/steamapps/common/War Thunder/linux64/aces'
printf 'YOURPASSWORD\n' | sudo -S optirun -c :8 nvidia-smi -pm 0




Another tip is to run the launch scripts from your favorite DE via a terminal session:

xvt e /home/joenotsopro/bin/launchscript.sh

...or direct from the terminal window itself. This has the added bonus of an easy way out (kill the terminal)
if something goes slightly bonkers, as it sometimes does. Oh and do use xvt for launching scripts as it has a 
tiny footprint (around 1MB in LMDE's Cinnamon DE) compared to other more fancy terminal emulators which are pure 
whoppers in terms of memory usage.




One other tip I can mention for laptop gaming is to install cpupower and pre-set your CPU's frequencies on boot
up. You can do this by:

sudo apt-get install linux-cpupower

then add:

printf 'YOURPASSWORD\n' | sudo -S cpupower frequency-set -f 2500Mhz

to the start of $HOME/.xsessionrc




Good luck and have fun!
